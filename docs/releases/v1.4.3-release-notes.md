# Release Notes: v1.4.3 - Complete JSON Traceability Fix

**Release Date:** November 17, 2025
**Type:** Patch Release (Critical)

## Overview

Version 1.4.3 completes the JSON traceability fix that was partially implemented in v1.4.2. While v1.4.2 ensured that targets always appear in JSON output, it **failed to include target-level warnings** in the structured data, making the JSON output non-actionable for SIEM/CI automation.

---

## Critical Fix

### **Incomplete Target-Level Issue Serialization**

**Issue:** The v1.4.2 fix for "Early Return JSON Inconsistency" ensured that targets with permission issues appeared in the JSON `targets` array, but the permission warnings themselves were **never written to the JSON payload**.

**Root Cause Analysis:**

The `audit_auth_keys` function (ssh-key-audit.sh:208-398) tracks two types of issues:

1. **Key-level issues** (weak-type, stale, duplicate, unsafe-options) ‚Üí serialized in `keys[].issues`
2. **Target-level issues** (.ssh perms, authorized_keys perms/missing) ‚Üí **only logged to console**

Lines 218-223 and 249-253 detect permission problems and:
- Print warnings to console ‚úì
- Increment `warn_count`/`crit_count` ‚úì
- Increment `user_issues` ‚úì
- **Never add to JSON** ‚úó

Lines 232 and 395 construct JSON entries:
```json
{
  "user": "alice",
  "path": "/home/alice/.ssh/authorized_keys",
  "is_system": false,
  "keys": [ ... ]  // Only per-key issues included
}
```

**Impact Example:**

```bash
# User with bad .ssh permissions (755) and no authorized_keys
tmpdir=$(mktemp -d)
mkdir -p "$tmpdir/alice/.ssh"
chmod 755 "$tmpdir/alice/.ssh"

# v1.4.2 output (INCOMPLETE FIX):
./ssh-key-audit.sh --users alice --home-root "$tmpdir" --json
# Console: ‚ö† alice: ~/.ssh permissions 755 (expected 700)
# Console: Warnings: 1, Targets with issues: 1  ‚Üê v1.4.2 fixed this
# JSON: "targets_with_issues": 1  ‚Üê v1.4.2 fixed this
# JSON: { "user": "alice", "keys": [] }  ‚Üê v1.4.2 fixed this
# BUT: No indication of *what* the issue is! ‚úó

# Multi-user scenario (even worse):
./ssh-key-audit.sh --users "alice,bob,charlie" --home-root "$tmpdir" --json
# JSON shows: "targets_with_issues": 2
# JSON targets: [ {...}, {...}, {...} ]
# Problem: Which 2 of the 3 targets have issues? Impossible to determine!
```

**SIEM/CI Automation Failure:**

Even after v1.4.2, JSON consumers still cannot:
- Distinguish between "clean user with no keys" vs "user with permission issues"
- Identify which specific targets triggered warnings when scanning multiple users
- Generate actionable alerts (no structured field to query)
- Correlate console warnings with JSON entries

---

## Solution

### **New `target_issues` Field**

Added a `target_issues` array to each target object in the JSON output:

```json
{
  "user": "alice",
  "path": "/home/alice/.ssh/authorized_keys",
  "is_system": false,
  "target_issues": [
    "ssh-dir-perms:755",
    "auth-keys-missing"
  ],
  "keys": []
}
```

**Issue Codes:**

| Code | Meaning | Console Warning | Counts as Issue? |
|------|---------|-----------------|------------------|
| `ssh-dir-perms:XXX` | .ssh directory has permissions XXX instead of 700 | `~/.ssh permissions XXX (expected 700)` | ‚úì Yes |
| `auth-keys-perms:XXX` | authorized_keys has permissions XXX instead of 600 | `authorized_keys permissions XXX (expected 600)` | ‚úì Yes |
| `auth-keys-missing` | authorized_keys file does not exist | *(no console warning)* | ‚úó No (informational) |

**Important:** `auth-keys-missing` is tracked in `target_issues` for SIEM visibility but does NOT increment `targets_with_issues`, `warn_count`, or affect exit codes. Rationale: Users may legitimately have no SSH access configured. SIEM consumers should filter on `target_issues` content, not aggregate counts.

**Console Visibility:** To address the risk of operators missing informational findings when running without `--json`, the console summary now includes:
```
Targets with missing authorized_keys: N (informational)
```
This line appears only when N > 0, ensuring operators are aware of missing key files even in non-JSON mode.

**Implementation:**

1. Added `target_issues=()` array at ssh-key-audit.sh:215
2. Append structured codes when permission checks fail (lines 223, 253)
3. Append `auth-keys-missing` when file doesn't exist (line 229)
4. Serialize array in both JSON output paths (lines 236-242, 388-395)

---

## Behavioral Changes

### Before (v1.4.2):

```json
{
  "targets": [
    {
      "user": "alice",
      "path": "/home/alice/.ssh/authorized_keys",
      "is_system": false,
      "keys": []
    }
  ],
  "targets_with_issues": 1
}
```

**Problem:** Impossible to tell why alice has issues or even if she's the one with issues (in multi-user scans).

### After (v1.4.3):

```json
{
  "targets": [
    {
      "user": "alice",
      "path": "/home/alice/.ssh/authorized_keys",
      "is_system": false,
      "target_issues": ["ssh-dir-perms:755", "auth-keys-missing"],
      "keys": []
    }
  ],
  "targets_with_issues": 1
}
```

**Benefit:** SIEM can now:
- Filter targets where `target_issues` is non-empty
- Alert on specific permission values (e.g., world-readable 755)
- Track which hosts/users have missing key files
- Generate compliance reports with full context

---

## Testing & Validation

### Test Scenarios

Created comprehensive test suite covering all edge cases:

**Scenario 1: alice** - Bad .ssh perms (755) with valid key
```json
{
  "user": "alice",
  "target_issues": ["ssh-dir-perms:755"],
  "keys": [{"type": "ssh-ed25519", "comment": "alice@host", "issues": []}]
}
```

**Scenario 2: bob** - Good perms, no authorized_keys file
```json
{
  "user": "bob",
  "target_issues": ["auth-keys-missing"],
  "keys": []
}
```

**Scenario 3: charlie** - Bad authorized_keys perms (644)
```json
{
  "user": "charlie",
  "target_issues": ["auth-keys-perms:644"],
  "keys": [{"type": "ssh-ed25519", "comment": "charlie@host", "issues": []}]
}
```

**Scenario 4: david** - Bad .ssh perms AND no authorized_keys
```json
{
  "user": "david",
  "target_issues": ["ssh-dir-perms:755", "auth-keys-missing"],
  "keys": []
}
```

**Scenario 5: eve** - Completely clean (control)
```json
{
  "user": "eve",
  "target_issues": [],
  "keys": [{"type": "ssh-ed25519", "comment": "eve@host", "issues": []}]
}
```

### Verification

```bash
# Multi-user audit
./ssh-key-audit.sh --users "alice,bob,charlie,david,eve" \
  --home-root /tmp/test_ssh_audit --json

# Console output:
# ‚ö† alice: ~/.ssh permissions 755 (expected 700)
# ‚ö† charlie: authorized_keys permissions 644 (expected 600)
# ‚ö† david: ~/.ssh permissions 755 (expected 700)
# Targets with issues: 3  (alice, charlie, david - bob not counted)
# Targets with missing authorized_keys: 2 (informational)  ‚Üê bob, david

# JSON output shows target_issues for ALL 4 non-clean targets:
jq '.targets[] | select(.target_issues | length > 0) | {user, target_issues}' \
  logs/ssh-key-audit/ssh_audit_summary_*.json

# Output (4 targets, but only 3 counted as "issues"):
# {"user": "alice", "target_issues": ["ssh-dir-perms:755"]}
# {"user": "bob", "target_issues": ["auth-keys-missing"]}  ‚Üê informational only
# {"user": "charlie", "target_issues": ["auth-keys-perms:644"]}
# {"user": "david", "target_issues": ["ssh-dir-perms:755", "auth-keys-missing"]}
```

---

## Upgrade Notes

### From v1.4.2

**Breaking Change:** JSON schema now includes `target_issues` field in every target object.

**Migration Guide for JSON Consumers:**

1. **Old code (v1.4.2):**
   ```python
   # BAD: Cannot identify which targets have issues
   if data['targets_with_issues'] > 0:
       print(f"Found {data['targets_with_issues']} targets with issues")
       # No way to determine WHICH targets or WHAT issues!
   ```

2. **New code (v1.4.3):**
   ```python
   # GOOD: Full traceability
   for target in data['targets']:
       if target['target_issues']:
           print(f"{target['user']}: {', '.join(target['target_issues'])}")
           # alice: ssh-dir-perms:755
           # charlie: auth-keys-perms:644
           # david: ssh-dir-perms:755, auth-keys-missing
   ```

**Recommended Actions:**

1. Update JSON parsing code to consume `target_issues` field
2. Add SIEM alerts for specific permission patterns:
   - `ssh-dir-perms:[^7].*` (any non-700 .ssh directory)
   - `auth-keys-perms:[^6].*` (any non-600 authorized_keys)
3. **Important:** Filter on `target_issues` content, not `targets_with_issues` count:
   ```python
   # CORRECT: Filter by issue type
   for target in data['targets']:
       perm_issues = [i for i in target['target_issues']
                      if i.startswith('ssh-dir-perms:') or i.startswith('auth-keys-perms:')]
       if perm_issues:
           alert(f"{target['user']}: {perm_issues}")

   # ALSO VALID: Track missing files separately (informational)
   for target in data['targets']:
       if 'auth-keys-missing' in target['target_issues']:
           log_info(f"{target['user']}: no SSH keys configured")
   ```
4. Generate compliance reports showing permission violations per user
5. Re-run historical audits to capture previously invisible permission issues

### Installation

```bash
# Update repository
git pull origin main
git checkout v1.4.3

# Verify version
./ssh-key-audit.sh --help | grep VERSION
# VERSION: 1.4.3

# Test with multi-user scenario
./ssh-key-audit.sh --users "alice,bob,charlie,david,eve" \
  --home-root /path/to/homes --json

# Inspect JSON structure
jq '.targets[0]' logs/ssh-key-audit/ssh_audit_summary_*.json
# Should include "target_issues" field
```

---

## Statistics

- **Bugs fixed:** 1 (critical - incomplete JSON traceability)
- **Lines changed:** ~32 (target_issues tracking, JSON serialization)
- **New fields:** 1 (`target_issues` array in JSON schema)
- **Compatibility:** **Breaking change** for JSON consumers (new required field)

---

## Security Impact

| Issue | CVSS Score | Severity | Attack Vector |
|-------|------------|----------|---------------|
| Incomplete JSON traceability | 6.5 | Medium | SIEM/CI cannot detect permission issues in automated scans |

**Impact Details:**

- **Pre-v1.4.3:** Automated security pipelines using JSON output were blind to permission issues
- **Compliance risk:** Audit reports showed aggregate counts but no actionable data
- **Detection gap:** Multi-user scans couldn't identify *which* users had issues
- **Alert fatigue:** Operators had to manually correlate console warnings with JSON entries

**Recommendation:** Deploy v1.4.3 immediately to environments with:
- Automated compliance reporting
- SIEM integration for SSH key auditing
- Multi-tenant systems with per-user SSH access
- CI/CD pipelines with security gates

---

## Relationship to v1.4.2

The v1.4.2 release notes (lines 62-112) stated:

> **Fix:** Moved JSON entry creation and `USERS_WITH_ISSUES` increment **before** early return at line 226, ensuring every scanned target appears in the output
>
> **Impact:** Traceability: SIEM/CI automation couldn't identify which target triggered warnings

**Reality check:**

‚úÖ v1.4.2 **did** ensure targets appear in JSON
‚úÖ v1.4.2 **did** ensure `targets_with_issues` count is correct
‚ùå v1.4.2 **did NOT** serialize target-level warnings to JSON
‚ùå v1.4.2 **did NOT** restore traceability (still impossible to identify which targets have issues)

**Conclusion:** v1.4.2 was an **incomplete fix**. v1.4.3 completes the traceability guarantee by adding the missing `target_issues` field.

---

## Related Issues

- Completes the fix started in v1.4.2 for JSON consistency
- Addresses findings from comprehensive v1.4.2 review
- Enables full SIEM/CI integration for SSH key auditing
- Improves compliance reporting with structured target-level issues

---

## Contributors

- Adrian Wedd (@adrianwedd)
- Claude (AI code reviewer & pair programmer)

---

## Links

- **GitHub Repository:** https://github.com/adrianwedd/homelab-scripts
- **Full Changelog:** [CHANGELOG.md](../../CHANGELOG.md)
- **Previous Release:** [v1.4.2](v1.4.2-release-notes.md)

---

## Feedback & Issues

Found a bug or have a feature request? Please open an issue on GitHub:
https://github.com/adrianwedd/homelab-scripts/issues

---

**Stay secure! üîê**
