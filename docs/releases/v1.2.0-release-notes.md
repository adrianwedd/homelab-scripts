# Release v1.2.0: Operations Scripts

**Release Date:** November 13, 2025
**Phase:** Phase 2 Complete

---

## Overview

Version 1.2.0 delivers Phase 2 of the homelab-scripts project: **Operations Scripts**. This release adds three production-ready scripts for Docker Compose deployment, volume backup, and dynamic DNS management.

All scripts follow established security patterns from Phase 1, include comprehensive CI testing, and are fully documented with examples.

---

## New Scripts

### 1. `compose-redeploy.sh` - Safe Docker Compose Updates

Automates Docker Compose deployments with pre-flight validation, optional volume backups, and automatic rollback on failure.

**Key Features:**
- Pre-flight compose file validation
- Optional volume backup before deployment
- Image pull with progress tracking
- Health check validation after deployment
- Automatic rollback on failure
- Support for both Compose v1 (`docker-compose`) and v2 (`docker compose`)
- Configurable health check timeout (default: 60s, range: 1-3600s)

**Usage:**
```bash
# Basic redeploy
./compose-redeploy.sh

# With volume backup
./compose-redeploy.sh --backup-volumes

# Custom compose file and timeout
./compose-redeploy.sh --file production.yml --health-timeout 120
```

**Example:** `examples/compose-redeploy-example.sh` and `examples/test-app-compose.yml`

---

### 2. `docker-volume-backup.sh` - Docker Volume Snapshots

Creates consistent Docker volume backups with optional container stop/restart for data consistency.

**Key Features:**
- Backup individual volumes or all volumes
- Optional container stop/restart for consistency
- Tar.gz compression via helper container
- Automatic container restart after backup
- Container dependency detection
- Path validation (blocks system dirs, requires $HOME)

**Usage:**
```bash
# Backup single volume
./docker-volume-backup.sh --volume postgres_data

# Backup all volumes with container stop
./docker-volume-backup.sh --all --stop

# Custom output directory
./docker-volume-backup.sh --volume app_data --out ~/backups
```

**Example:** `examples/docker-volume-backup-example.sh`

---

### 3. `dyndns-update.sh` - Dynamic DNS Updates

Keeps DNS records synchronized with changing public IPs for homelabs and home servers.

**Key Features:**
- Cloudflare DNS API integration
- Public IP detection with fallback sources (ifconfig.me, icanhazip.com, ipinfo.io, ipify.org)
- IP caching to avoid unnecessary API calls
- Rate limiting (max 1 update per 5 minutes)
- Configurable TTL (default: 300s, range: 60-86400s)
- Secure token handling via environment variables
- Automatic DNS record creation if not exists

**Usage:**
```bash
# Basic Cloudflare update
export CF_TOKEN="your-token"
./dyndns-update.sh --provider cloudflare --zone example.com \
    --record home --token env:CF_TOKEN

# With custom TTL
./dyndns-update.sh --provider cloudflare --zone example.com \
    --record home --token env:CF_TOKEN --ttl 600

# Dry run to preview
./dyndns-update.sh --provider cloudflare --zone example.com \
    --record home --token env:CF_TOKEN --dry-run
```

**Example:** `examples/dyndns-update-example.sh`

---

## Quality Improvements

### Policy Compliance
- All Phase 2 scripts updated to use `set -u` only (removed `set -e` per repository policy)
- Ensures cleanup continuation on non-critical errors

### Dependency Management
- compose-redeploy now checks for `jq` before using `--json` flag
- Clear error messages with installation instructions

### Image Availability
- compose-redeploy and docker-volume-backup pre-check/pull `alpine:latest`
- Prevents backup failures on offline or restricted systems

### Path Security
- docker-volume-backup now validates output paths
- Blocks system directories (`/usr`, `/etc`, `/var`, etc.)
- Requires paths under `$HOME` (aligned with db-backup.sh v1.1.1 security policy)

### Documentation
- Fixed duplicate CHANGELOG [1.1.1] section
- Added jq dependency note to README for compose-redeploy
- Complete README sections for all three new scripts (sections 7-9)

---

## Testing

### CI Coverage
All scripts include comprehensive smoke tests:
- Help flag validation
- Dry-run mode testing
- Argument validation
- Bounds checking
- Dependency detection
- Graceful failure handling

### Quality Assurance
- âœ… Syntax validation (`bash -n`)
- âœ… ShellCheck (zero warnings)
- âœ… Code formatting (`shfmt`)
- âœ… Pre-commit hooks
- âœ… Manual testing

---

## Documentation

### Updated Files
- **README.md** - Added sections 7-9 with usage examples
- **CHANGELOG.md** - Complete v1.2.0 entry
- **ROADMAP.md** - Phase 2 marked complete
- **Examples** - 3 new example scripts and 1 test compose file

### New Documentation
- `examples/compose-redeploy-example.sh`
- `examples/docker-volume-backup-example.sh`
- `examples/dyndns-update-example.sh`
- `examples/test-app-compose.yml`

---

## Dependencies

### For compose-redeploy.sh:
- `docker` - Docker Engine
- `docker-compose` or `docker compose` - Compose v1 or v2
- `jq` (optional) - For `--json` output

### For docker-volume-backup.sh:
- `docker` - Docker Engine

### For dyndns-update.sh:
- `curl` - HTTP client
- `jq` - JSON processor

---

## Upgrade Notes

### From v1.1.1
No breaking changes. All Phase 1 scripts remain unchanged. Phase 2 scripts are new additions.

### Security
All scripts follow v1.1.1 security standards:
- Secure logging (`umask 077`, directory permissions `700`)
- Path validation (system directory blocking)
- No secrets in CLI arguments
- Comprehensive bounds checking

---

## Phase Status

### Phase 1 âœ… Complete (v1.1.0)
- cert-renewal-check.sh
- db-backup.sh
- service-health-check.sh

### Phase 2 âœ… Complete (v1.2.0)
- compose-redeploy.sh
- docker-volume-backup.sh
- dyndns-update.sh

### Phase 3 ðŸ”œ Planned
- smart-disk-check.sh (S.M.A.R.T. monitoring)
- new-vm-setup.sh (VM bootstrapping)

---

## Contributors

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>

---

## Links

- **GitHub Repository:** https://github.com/adrianwedd/homelab-scripts
- **Full Changelog:** [CHANGELOG.md](../../CHANGELOG.md)
- **Documentation:** [README.md](../../README.md)
- **Roadmap:** [ROADMAP.md](../../ROADMAP.md)
