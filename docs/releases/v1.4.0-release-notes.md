# Release Notes: v1.4.0 - SSH Key Auditing

**Release Date:** November 16, 2025
**Codename:** Security Hygiene

## Overview

Version 1.4.0 introduces **ssh-key-audit.sh**, a comprehensive SSH key hygiene auditing tool for detecting weak keys, permission issues, stale credentials, and security risks across authorized_keys files. This release focuses on proactive SSH security hardening and compliance validation.

## What's New

### ðŸ†• ssh-key-audit.sh - SSH Key Hygiene Auditing

Read-only security auditing tool for detecting SSH key vulnerabilities and compliance violations across user and system authorized_keys files.

**Key Features:**
- **User-scoped audits:** Scan specific users with `--users` or all users under a home root
- **System-wide coverage:** Optional system-level file auditing (`/etc/ssh/authorized_keys`, `/etc/ssh/authorized_keys.d`, `/root/.ssh/authorized_keys`)
- **Weak key detection:** Configurable forbidden key types (default: `ssh-rsa`)
- **Permission validation:** Verifies `~/.ssh` (700) and `authorized_keys` (600) permissions
- **Stale key detection:** Age-based flagging with configurable `--max-age` threshold
- **Duplicate detection:** Exact matching on `keytype:base64blob` to prevent key sprawl
- **Unsafe options detection:** Flags risky authorized_keys options (`command=`, `from=`, etc.)
- **Fail-on rules:** Elevate warnings to critical failures for CI/CD integration
- **JSON output:** Structured data for SIEM and monitoring system integration
- **Exit codes:** 0 (healthy), 1 (warnings), 2 (critical via `--fail-on`)

**Usage:**
```bash
# Audit specific users
./ssh-key-audit.sh --users "alice,bob,charlie"

# Audit all users under /home
./ssh-key-audit.sh --all-users

# Include system-level SSH key files
./ssh-key-audit.sh --all-users --system

# Custom home root (testing, containers)
./ssh-key-audit.sh --users "deploy" --home-root /opt/users

# Forbid multiple key types and flag stale keys
./ssh-key-audit.sh --all-users --forbid-types "ssh-rsa,ssh-dss" --max-age 365

# Elevate weak keys to critical failures (CI/CD)
./ssh-key-audit.sh --all-users --fail-on weak-type,perms --json

# Dry-run preview
./ssh-key-audit.sh --users alice --dry-run
```

**CI/CD Integration:**
```bash
# Fail pipeline on weak RSA keys
./ssh-key-audit.sh --all-users --forbid-types ssh-rsa --fail-on weak-type || exit 1

# Compliance validation with JSON output
./ssh-key-audit.sh --all-users --system --max-age 90 --fail-on weak-type,perms,stale --json
```

**Cron Integration:**
```bash
# Weekly SSH hygiene audit with email alerts
0 3 * * 1 /path/to/ssh-key-audit.sh --all-users --system --json || \
  mail -s 'SSH Key Audit Warnings' security@example.com < /path/to/logs/ssh-key-audit/latest.log
```

**Security & Safety:**
- **Read-only:** No modifications to any files
- **Graceful degradation:** Handles missing directories and unreadable files
- **Cross-platform:** Linux and macOS compatibility (permission checks adapt to OS)
- **Secure logging:** Logs under `./logs/ssh-key-audit/` (mode 700, file mode 600)
- **Bash 3.x compatible:** Works on macOS default bash

---

## Technical Details

### Implementation Patterns
Follows repository security best practices:
- **Error handling:** `set -u` (fail on undefined variables)
- **Validation:** RFC-1123 hostname, POSIX username validation
- **JSON escaping:** Comprehensive handling of control characters (backslash, quotes, tabs, CR, LF)
- **Duplicate detection:** Exact match with `grep -qFx` (not substring)
- **User-visible warnings:** All issues reported to operators via `print_warning`
- **Counter accuracy:** Separate tracking for user vs system targets

### Key Detection Logic
1. **Weak types:** Matches forbidden key types against `--forbid-types` list
2. **Unsafe options:** Any non-key-type prefix (e.g., `command=`, `from=`, `no-port-forwarding`)
3. **Stale keys:** Age calculated from comment dates (YYYY-MM-DD, YYYY/MM/DD) or file mtime
4. **Duplicates:** Normalizes to `keytype:base64blob`, exact matching only

### Exit Code Semantics
- **0:** No issues detected (clean bill of health)
- **1:** Warnings found (informational, not elevated by `--fail-on`)
- **2:** Critical failures (issues matching `--fail-on` rules)

### JSON Schema
```json
{
  "timestamp": "2025-11-16T22:46:15Z",
  "home_root": "/home",
  "users_scanned": 5,
  "system_targets_scanned": 2,
  "total_targets": 7,
  "users_with_issues": 2,
  "total_keys": 23,
  "warnings": 4,
  "critical": 0,
  "keys_by_user": {
    "alice": [
      {
        "type": "ssh-ed25519",
        "comment": "alice@laptop generated-2024-01-15",
        "age_days": 306,
        "issues": []
      }
    ]
  }
}
```

---

## Documentation Improvements

### Examples Added
- `examples/ssh-key-audit-example.sh` - 8+ real-world audit scenarios covering user-specific, system-wide, custom home roots, and CI/CD integration

### README Updates
- **Section 12:** `ssh-key-audit.sh` with features table, options reference, security notes, and practical examples

### CI/CD Coverage
- Comprehensive smoke tests for ssh-key-audit.sh
- Validation tests covering mutual exclusion, bounds checking, fail-on behavior
- Fixture-based testing with alice (clean) and bob (problematic keys)
- JSON output verification

---

## Bug Fixes & Improvements

### Critical Fixes (User-Identified)
1. **Missing warnings:** Added `print_warning` calls for all issue types (weak-type, unsafe-options, stale, duplicate) - operators can now see which keys have issues
2. **Duplicate detection bug:** Fixed substring matching (`grep -qF` â†’ `grep -qFx`) - prevents false positives when key blobs are prefixes
3. **JSON escaping:** Comprehensive control character escaping (backslash, quotes, tab, CR, LF) - ensures valid JSON for downstream tooling
4. **System-only counters:** Added `TOTAL_SYSTEM_TARGETS` tracking - system-only audits now report accurate statistics

### Compatibility Fixes
1. **Bash 3.x compatibility:** Replaced `${var,,}` with `tr` for lowercase conversion
2. **Associative arrays:** Changed to newline-separated strings for macOS Bash 3.x
3. **Empty array handling:** Added `[ -n "$FAIL_ON" ]` guards for `set -u` compliance

---

## Upgrade Notes

### From v1.3.x

No breaking changes. New script is additive:
- Add `ssh-key-audit.sh` to your security monitoring workflows
- Integrate with CI/CD pipelines using `--fail-on` and `--json`

### Installation

```bash
# Update repository
git pull origin main

# Make script executable (if not already)
chmod +x ssh-key-audit.sh

# Run first audit
./ssh-key-audit.sh --all-users --dry-run
```

---

## Roadmap Status

### âœ… Release v1.4.0 Complete
- âœ… ssh-key-audit.sh - SSH key hygiene auditing and compliance validation

### ðŸ”œ Release v1.5.0 (Planned)
- fail2ban-report.sh - Ban analytics and security posture reporting
- Fail2ban integration and SSH attack pattern analysis

### ðŸ”œ Release v1.6.0 (Planned)
- zfs-snapshot-manager.sh - Snapshot lifecycle and retention management
- ZFS replication and backup verification

---

## Statistics

- **Scripts added:** 1
- **Example scripts:** 1
- **Lines of code:** ~340 (ssh-key-audit.sh)
- **Bug fixes:** 7 (4 critical, 3 compatibility)
- **CI tests added:** 15+ test cases
- **Documentation:** 1 README section, comprehensive examples

---

## Contributors

- Adrian Wedd (@adrianwedd)
- Claude (AI pair programmer)

---

## Links

- **GitHub Repository:** https://github.com/adrianwedd/homelab-scripts
- **Full Changelog:** [CHANGELOG.md](../../CHANGELOG.md)
- **Roadmap:** [ROADMAP.md](../../ROADMAP.md)
- **Previous Release:** [v1.3.0](v1.3.0-release-notes.md)

---

## Feedback & Issues

Found a bug or have a feature request? Please open an issue on GitHub:
https://github.com/adrianwedd/homelab-scripts/issues

---

**Stay secure! ðŸ”**
