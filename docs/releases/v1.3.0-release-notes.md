# Release Notes: v1.3.0 - Phase 3 Complete

**Release Date:** November 16, 2025
**Codename:** Infrastructure Automation

## Overview

Version 1.3.0 completes **Phase 3** of the homelab-scripts roadmap, delivering two major infrastructure automation tools: S.M.A.R.T. disk health monitoring and automated VM bootstrapping. This release focuses on proactive system monitoring and streamlined server provisioning.

## What's New

### ðŸ†• smart-disk-check.sh - Disk Health Monitoring

Proactive S.M.A.R.T. monitoring and alerting system for detecting disk failures before data loss.

**Key Features:**
- **Auto-discovery:** Scans all available drives via `smartctl --scan`
- **Health monitoring:** Tracks critical pre-fail attributes (5, 187, 188, 197, 198)
- **Temperature alerts:** Configurable thresholds (default: warn 50Â°C, critical 60Â°C)
- **Test scheduling:** Supports short/long/conveyance S.M.A.R.T. tests
- **Sector tracking:** Detects reallocated and pending sectors
- **JSON output:** Structured data for integration with monitoring systems
- **Exit codes:** 0 (healthy), 1 (warnings), 2 (critical failures)

**Usage:**
```bash
# Quick health check
./smart-disk-check.sh

# Specific devices with custom thresholds
./smart-disk-check.sh --devices /dev/sda,/dev/nvme0n1 --warn-temp 45 --crit-temp 55

# Run long test and output JSON
./smart-disk-check.sh --test long --json

# Dry-run preview
./smart-disk-check.sh --dry-run
```

**Cron Integration:**
```bash
# Daily health monitoring with email alerts
0 6 * * * /path/to/smart-disk-check.sh --json || mail -s 'Disk Health Alert' admin@example.com
```

**Security & Safety:**
- Gracefully handles missing `smartctl` dependency
- Read-only operations (no modifications to disks)
- Secure logging in `./logs/smart-disk-check/` (mode 700)

---

### ðŸ†• new-vm-setup.sh - Automated VM Bootstrapping

Streamlined initial configuration for fresh Linux VMs with comprehensive validation and idempotent operations.

**Key Features:**
- **OS detection:** Auto-detects Ubuntu, Debian, RHEL, CentOS, Fedora, Rocky, AlmaLinux via `/etc/os-release`
- **Package managers:** Supports apt-get, dnf, and yum with automatic selection
- **Hostname setup:** RFC-1123 validation and configuration via `hostnamectl`
- **User creation:** POSIX-compliant usernames with sudo/wheel group mapping
- **SSH keys:** Secure public key deployment with proper permissions (700/.ssh, 600/authorized_keys)
- **Package installation:** Idempotent package installs with pre-check
- **Dotfiles support:** Optional Git repository cloning (https://, ssh://, git@)
- **Configurable shell:** Custom login shell (default: /bin/bash)
- **Sudo options:** Optional passwordless sudo with explicit security warnings
- **Comprehensive validation:** Hostname, username, SSH key type, dotfiles URL validation
- **Sudo transparency:** Interactive confirmation prompts with `--yes` override
- **Idempotent:** Safe to re-run without side effects
- **JSON output:** Structured summary for automation
- **Dry-run mode:** Preview all operations without execution

**Usage:**
```bash
# Dry-run to preview configuration
./new-vm-setup.sh \
  --hostname "web-server-01" \
  --user "deploy" \
  --ssh-key-path "$HOME/.ssh/id_ed25519.pub" \
  --packages "curl,git,vim,htop" \
  --dry-run

# Full web server setup
./new-vm-setup.sh \
  --hostname "nginx-server" \
  --user "webadmin" \
  --ssh-key-path "$HOME/.ssh/id_ed25519.pub" \
  --packages "nginx,certbot,ufw,fail2ban" \
  --dotfiles "https://github.com/yourusername/dotfiles.git"

# CI/CD runner with passwordless sudo (non-interactive)
./new-vm-setup.sh \
  --hostname "gitlab-runner" \
  --user "ci" \
  --ssh-key-path "$HOME/.ssh/ci_key.pub" \
  --packages "docker.io,git,curl" \
  --sudo-nopass \
  --yes \
  --json

# Development VM with custom shell
./new-vm-setup.sh \
  --hostname "dev-box" \
  --user "developer" \
  --ssh-key "ssh-ed25519 AAAAC3Nz... user@host" \
  --packages "build-essential,git,vim,tmux,python3,nodejs" \
  --dotfiles "https://github.com/yourusername/dotfiles.git" \
  --shell "/bin/zsh" \
  --yes
```

**Common Scenarios:**
- **Web servers:** nginx + certbot + ufw + fail2ban
- **Database servers:** PostgreSQL/MySQL client and server packages
- **CI/CD runners:** Docker + Git with passwordless sudo
- **Development VMs:** Build tools + language runtimes + dotfiles

**Security & Safety:**
- **No plaintext passwords:** SSH keys only, never password authentication
- **Sudo transparency:** Explicit warnings before privilege escalation
- **Input validation:** Strict RFC-1123 hostname and POSIX username validation
- **Path security:** Secure logging in `./logs/new-vm-setup/` (mode 700)
- **Idempotent checks:** Safe to re-run; skips already-configured items
- **Preview mode:** `--no-sudo --dry-run` for testing without privileges

**Exit Codes:**
- `0`: Success (all operations completed)
- `1`: Warnings (some non-critical issues)

---

## Documentation Improvements

### Examples Added
- `examples/smart-disk-check-example.sh` - Device scanning and test scheduling patterns
- `examples/new-vm-setup-example.sh` - 10+ real-world VM bootstrap scenarios

### README Updates
- **Section 10:** `smart-disk-check.sh` with features table, examples, cron setup
- **Section 11:** `new-vm-setup.sh` with options table, security notes, dependencies

### CI/CD Coverage
- Comprehensive smoke tests for both new scripts
- Validation tests covering all input validation functions
- Dry-run tests ensuring graceful dependency handling
- JSON output verification

---

## Technical Details

### Implementation Patterns
Both scripts follow repository best practices:
- **Error handling:** `set -u` only (allows cleanup continuation)
- **Shared functions:** Source `lib/common.sh` for common utilities
- **Secure logging:** `umask 077`, directory permissions 700, file permissions 600
- **Cross-platform:** macOS and Linux compatibility where applicable
- **Graceful degradation:** Handle missing dependencies with clear error messages

### Dependencies

**smart-disk-check.sh:**
- `smartctl` (from smartmontools package)
- Optional: `jq` for `--json` output

**new-vm-setup.sh:**
- Linux with `/etc/os-release` (Ubuntu, Debian, RHEL, CentOS, Fedora, Rocky, AlmaLinux)
- Package manager: `apt-get`, `dnf`, or `yum`
- `sudo` for privilege escalation
- Optional: `git` for `--dotfiles` feature
- Optional: `jq` for `--json` output
- `hostnamectl` or `/etc/hostname` (fallback)

---

## Upgrade Notes

### From v1.2.x

No breaking changes. New scripts are additive:
- Add `smart-disk-check.sh` to your monitoring cron jobs
- Use `new-vm-setup.sh` for new VM provisioning workflows

### Installation

```bash
# Update repository
git pull origin main

# Make new scripts executable (if not already)
chmod +x smart-disk-check.sh new-vm-setup.sh

# Install dependencies (if needed)
# For smart-disk-check.sh
brew install smartmontools  # macOS
apt install smartmontools    # Debian/Ubuntu
dnf install smartmontools    # Fedora/RHEL

# For JSON output (both scripts)
brew install jq  # macOS
apt install jq   # Debian/Ubuntu
dnf install jq   # Fedora/RHEL
```

---

## Roadmap Status

### âœ… Phase 3 Complete (v1.3.0)
- âœ… smart-disk-check.sh - S.M.A.R.T. monitoring and disk health alerts
- âœ… new-vm-setup.sh - VM bootstrapping and initial configuration

### ðŸ”œ Phase 4 (Planned)
- Network security scanning and vulnerability assessment
- Automated backup verification and testing
- Log aggregation and analysis tools

---

## Statistics

- **Scripts added:** 2
- **Example scripts:** 2
- **Lines of code:** ~1,000+ (795 in new-vm-setup.sh, 280+ in smart-disk-check.sh)
- **CI tests added:** 100+ test cases
- **Documentation:** 2 README sections, comprehensive examples

---

## Contributors

- Adrian Wedd (@adrianwedd)
- Claude (AI pair programmer)

---

## Links

- **GitHub Repository:** https://github.com/adrianwedd/homelab-scripts
- **Full Changelog:** [CHANGELOG.md](../../CHANGELOG.md)
- **Roadmap:** [ROADMAP.md](../../ROADMAP.md)
- **Previous Release:** [v1.2.1](v1.2.1-release-notes.md)

---

## Feedback & Issues

Found a bug or have a feature request? Please open an issue on GitHub:
https://github.com/adrianwedd/homelab-scripts/issues

---

**Happy automating! ðŸš€**
