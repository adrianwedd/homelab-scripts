# Release Notes: v1.4.1 - Critical Bug Fixes

**Release Date:** November 16, 2025
**Type:** Patch Release

## Overview

Version 1.4.1 addresses 5 critical bugs discovered in v1.4.0 immediately after release, affecting parser coverage, JSON validity, and user experience.

## Critical Fixes

### 1. Parser Coverage - Modern Key Types
**Issue:** Parser only recognized ssh-rsa, ssh-ed25519, and ecdsa-sha2-nistp* key types. Modern FIDO keys (sk-*), certificate keys (*-cert-v01@openssh.com), and legacy ssh-dss keys were flagged as "Unrecognized key line", bypassing all auditing logic.

**Impact:** Enterprise environments using FIDO U2F/WebAuthn keys, certificate-based authentication, or legacy DSA keys received false warnings and no security governance.

**Fix:** Comprehensive OpenSSH key type regex now covers:
- **FIDO/U2F**: `sk-ssh-ed25519@openssh.com`, `sk-ecdsa-sha2-nistp256@openssh.com`
- **Certificates**: `ssh-rsa-cert-v01@openssh.com`, `ssh-ed25519-cert-v01@openssh.com`, etc.
- **Legacy**: `ssh-dss` (DSA)
- **Modern**: `ssh-ed448` (Ed448)

All key types now properly audited against `--forbid-types` rules.

---

### 2. Options Parsing - Comment Collision
**Issue:** When a key entry had options AND the comment repeated the key type (e.g., `command="/bin/sync" ssh-ed25519 AAAA... ssh-ed25519 backup`), greedy sed patterns latched onto the LAST occurrence of the key type, causing:
- Key blob extraction failure (grabbed comment instead)
- Duplicate detection breakage
- Weak-type detection failures

**Impact:** Common in enterprise environments where comments annotate key provenance ("ssh-ed25519 production server").

**Fix:** Replaced sed-based parsing with awk field iteration to find the FIRST key type token, properly extracting options, blob, and comment with word-boundary awareness.

---

### 3. JSON Schema Mismatch
**Issue:** JSON output didn't match documented schema in release notes:
- Missing: `home_root`, `system_targets_scanned`, `total_targets`, `targets_with_issues`
- Incorrect: Used `users` instead of `targets`, `users_with_issues` instead of `targets_with_issues`
- Missing: `is_system` boolean in each target object

**Impact:** SIEM integrations, CI/CD parsers, and automation tooling built against documented schema failed to parse actual output.

**Fix:** Updated JSON output to match documented schema:
```json
{
  "home_root": "/home",
  "users_scanned": 5,
  "system_targets_scanned": 2,
  "total_targets": 7,
  "targets_with_issues": 2,
  "targets": [
    {
      "user": "alice",
      "path": "/home/alice/.ssh/authorized_keys",
      "is_system": false,
      "keys": [...]
    }
  ]
}
```

---

### 4. JSON String Escaping - Path/User Fields
**Issue:** Only key comments were JSON-escaped. `target_user`, `path`, and `log_file` fields were inserted verbatim, breaking JSON validity when paths contained:
- Spaces: `--home-root "./users/space dir"`
- Quotes/backslashes: Windows-style paths, escaped characters

**Impact:** JSON parsers (jq, Python json, CI tools) failed with syntax errors on valid file paths.

**Fix:** All string fields now run through `json_escape()` function before JSON insertion.

---

### 5. Whitespace Handling - List Parsing
**Issue:** Comma/colon list parsing never trimmed whitespace. Realistic inputs like:
- `--users "alice, bob"` (space after comma)
- `--system-paths "/etc/ssh/authorized_keys: /etc/ssh/custom"` (space after colon)

Produced entries with leading spaces, causing lookups to fail silently:
- Home directory lookup: `tests/fixtures/ssh/ bob` (non-existent)
- System path check: ` /etc/ssh/custom` (non-existent)

**Impact:** Audits returned "clean" or "Users scanned: 0" despite valid user list, zero operator feedback.

**Fix:** Added `trim()` helper function, applied to all comma/colon-separated list parsing (`--users`, `--forbid-types`, `--fail-on`, `--system-paths`).

---

## Testing

### New Test Fixtures
Added `tests/fixtures/ssh/charlie/` with comprehensive edge cases:
- FIDO key: `sk-ssh-ed25519@openssh.com`
- Certificate key: `ssh-ed25519-cert-v01@openssh.com`
- Legacy DSA: `ssh-dss`
- Options collision: `command="/usr/bin/sync" ssh-ed25519 AAAA... ssh-ed25519 backup key`

### Validation
All fixes verified with:
```bash
./ssh-key-audit.sh --users "alice, bob, charlie" --home-root tests/fixtures/ssh --forbid-types "ssh-rsa, ssh-dss" --json
```

Results:
- ‚úÖ 3 users scanned (whitespace trimming works)
- ‚úÖ 8 keys detected (FIDO, certs, DSA all parsed)
- ‚úÖ Options collision handled correctly
- ‚úÖ JSON output valid and schema-compliant
- ‚úÖ All strings properly escaped

---

## Upgrade Notes

### From v1.4.0

**Breaking Change:** JSON schema updated to match documentation. If you built integrations against v1.4.0 JSON output:
- Rename `users` ‚Üí `targets`
- Rename `users_with_issues` ‚Üí `targets_with_issues`
- Handle new fields: `home_root`, `system_targets_scanned`, `total_targets`
- Check for `is_system` boolean in target objects

**Non-breaking:** All other changes are fixes; no CLI flag changes.

### Installation

```bash
# Update repository
git pull origin main
git checkout v1.4.1

# Verify fixes
./ssh-key-audit.sh --users "alice, bob" --home-root /home --json
```

---

## Statistics

- **Bugs fixed:** 5 critical
- **Lines changed:** ~120 (parser, JSON output, list handling)
- **Test fixtures added:** 1 (charlie with modern key types)
- **Compatibility:** No CLI changes, JSON schema updated

---

## Contributors

- Adrian Wedd (@adrianwedd)
- Claude (AI pair programmer)

---

## Links

- **GitHub Repository:** https://github.com/adrianwedd/homelab-scripts
- **Full Changelog:** [CHANGELOG.md](../../CHANGELOG.md)
- **Previous Release:** [v1.4.0](v1.4.0-release-notes.md)

---

## Feedback & Issues

Found a bug or have a feature request? Please open an issue on GitHub:
https://github.com/adrianwedd/homelab-scripts/issues

---

**Stay secure! üîê**
