# v1.5.0 Release Notes - Risk Scoring and Prioritization

**Release Date:** 2025-11-17
**Type:** Minor Release (New Features)

## Overview

v1.5.0 introduces a comprehensive risk scoring system that transforms ssh-key-audit.sh from a simple hygiene checker into a prioritization engine. Operators can now instantly identify the highest-risk SSH targets across their infrastructure and focus remediation efforts where they matter most.

## Key Features

### ðŸŽ¯ Risk Scoring Engine

Pure bash risk calculator (no jq dependency) that assigns numeric risk scores (0-100) to each audited target based on:

- **Target-level issues**: Directory/file permissions, missing files
- **Key-level issues**: Weak crypto, unsafe options, duplication, staleness
- **Context multipliers**: 1.25Ã— weight for system-critical paths (/root, /etc/ssh)

**Formula:**
```
final_score = min(target_score + max_key_score, 100) Ã— system_multiplier
```

### ðŸŽ¨ Color-Coded Console Output

Risk summary shows distribution and top N risky targets at a glance:

```
â”â”â” Risk Distribution â”â”â”

ðŸ”´ CRITICAL: 2 targets
ðŸŸ  HIGH: 5 targets
ðŸŸ¡ MEDIUM: 12 targets
ðŸ”µ LOW: 8 targets
ðŸŸ¢ CLEAN: 23 targets

â”â”â” Top Risky Targets â”â”â”

ðŸ”´ root (score: 90, level: CRITICAL)
   Top issues: weak-type:ssh-rsa, ssh-dir-perms

ðŸŸ  webserver (score: 75, level: HIGH)
   Top issues: unsafe-options, duplicate
```

### âš™ï¸ Configurable Weights

Customize risk weights via:
1. CLI flag: `--risk-config /path/to/config`
2. Repo-local: `./.ssh-audit.conf`
3. User home: `~/.ssh-audit.conf`
4. System-wide: `/etc/ssh-audit/config.conf`

Example config (`examples/ssh-audit.conf`):
```bash
# Critical issues
SSH_AUDIT_RISK_WEAK_SSH_RSA=50
SSH_AUDIT_RISK_WEAK_SSH_DSS=50

# High-severity issues
SSH_AUDIT_RISK_SSH_DIR_PERMS=40
SSH_AUDIT_RISK_UNSAFE_OPTIONS=35
SSH_AUDIT_RISK_AUTH_KEYS_PERMS=35

# Medium-severity issues
SSH_AUDIT_RISK_STALE_365=25
SSH_AUDIT_RISK_DUPLICATE=20

# Low-severity issues
SSH_AUDIT_RISK_STALE_180=15
SSH_AUDIT_RISK_STALE_90=8
SSH_AUDIT_RISK_AUTH_KEYS_MISSING=5

# Opt-in warnings (default: 0)
SSH_AUDIT_RISK_WEAK_ECDSA_NIST=0  # Set to 30 to flag NIST curves
```

### ðŸ“Š Risk Levels

| Level    | Score Range | Color | Icon |
|----------|-------------|-------|------|
| CRITICAL | 85+         | Red   | ðŸ”´   |
| HIGH     | 50-84       | Red   | ðŸŸ    |
| MEDIUM   | 20-49       | Yellow| ðŸŸ¡   |
| LOW      | 1-19        | Blue  | ðŸ”µ   |
| CLEAN    | 0           | Green | ðŸŸ¢   |

### ðŸ”¬ Detailed Risk Breakdown

Use `--risk-detail` to see issue-by-issue analysis:

```bash
./ssh-key-audit.sh --all-users --risk-detail
```

Output includes:
- Target-level issues with weights and descriptions
- Per-key issues grouped by key index
- Full descriptions explaining the security impact

### ðŸ“„ JSON Integration

When `--risk` is enabled, JSON output includes:

```json
{
  "user": "webserver",
  "risk_score": 75,
  "risk_level": "HIGH",
  "risk_factors": [
    {
      "type": "target",
      "factor": "ssh-dir-perms",
      "weight": 40,
      "description": "World-readable ~/.ssh directory exposes key material (perms: 755)"
    },
    {
      "type": "key",
      "key_index": 0,
      "factor": "weak-type:ssh-rsa",
      "weight": 50,
      "description": "SHA-1 collision vulnerability in ssh-rsa signatures (deprecated OpenSSH 8.8+)"
    }
  ],
  "keys": [...]
}
```

Perfect for SIEM ingestion, CI/CD gates, and compliance reporting.

## CLI Usage

### Basic Risk Scoring

```bash
# Enable risk scoring (console summary + JSON fields)
./ssh-key-audit.sh --all-users --risk --json

# Show detailed breakdown for all targets
./ssh-key-audit.sh --all-users --risk-detail

# Use custom config
./ssh-key-audit.sh --all-users --risk --risk-config /etc/my-risk-policy.conf
```

### Integration Examples

**CI/CD quality gate** (fail if CRITICAL or HIGH targets found):
```bash
./ssh-key-audit.sh --all-users --risk --json > audit.json
high_count=$(jq '[.targets[] | select(.risk_level == "CRITICAL" or .risk_level == "HIGH")] | length' audit.json)
[ "$high_count" -eq 0 ] || { echo "âŒ $high_count high-risk targets found"; exit 1; }
```

**SIEM ingestion** (Splunk, Elastic, Datadog):
```bash
./ssh-key-audit.sh --all-users --risk --json | \
  curl -X POST https://siem.example.com/api/v1/logs \
    -H "Content-Type: application/json" \
    -d @-
```

**Weekly risk report** (email top 10 risky targets):
```bash
./ssh-key-audit.sh --all-users --risk --json | \
  jq -r '.targets | sort_by(.risk_score) | reverse | .[0:10] |
    .[] | "\(.user): \(.risk_score) (\(.risk_level))"' | \
  mail -s "Weekly SSH Key Risk Report" security-team@example.com
```

## Default Risk Weights

| Issue                          | Weight | Severity |
|--------------------------------|--------|----------|
| ssh-rsa (deprecated)           | 50     | Critical |
| ssh-dss (removed)              | 50     | Critical |
| Bad .ssh permissions           | 40     | High     |
| Unsafe key options             | 35     | High     |
| Bad authorized_keys perms      | 35     | High     |
| Stale key (365+ days)          | 25     | Medium   |
| Duplicate key                  | 20     | Medium   |
| Stale key (180-364 days)       | 15     | Low      |
| Stale key (90-179 days)        | 8      | Low      |
| Missing authorized_keys        | 5      | Info     |
| NIST ECDSA curves              | 0      | Opt-in   |

## Stale Key Logic

Stale keys use **non-additive** >= threshold buckets:

- **365+ days**: 25 pts
- **180-364 days**: 15 pts
- **90-179 days**: 8 pts
- **<90 days**: 0 pts

A key that's 547 days old scores **25 pts** (not 25+15+8).

## System Multiplier

Targets under system paths receive a 1.25Ã— score multiplier:

- `/root/.ssh/authorized_keys`
- `/etc/ssh/authorized_keys`
- `/etc/ssh/authorized_keys.d/*`

Example: A root user with score 80 becomes 100 (80 Ã— 1.25 = 100, capped).

## Configuration Discovery

Risk config is loaded in priority order:

1. **CLI flag**: `--risk-config /custom/path.conf` (highest priority)
2. **Repo-local**: `./.ssh-audit.conf` (per-project overrides)
3. **User home**: `~/.ssh-audit.conf` (personal defaults)
4. **System-wide**: `/etc/ssh-audit/config.conf` (org-wide policy)
5. **Built-in defaults**: If no config found

Weights are validated and clamped to [0, 100] on load.

## Backward Compatibility

âœ… **100% backward compatible**

- Risk scoring is **opt-in** via `--risk` flag
- Without `--risk`, output is identical to v1.4.3
- No breaking changes to existing JSON consumers
- All existing flags work unchanged

## Migration Guide

### From v1.4.x

No action required! v1.5.0 is a drop-in replacement.

To enable risk scoring:
```bash
# Before (v1.4.x)
./ssh-key-audit.sh --all-users --json

# After (v1.5.0) - same output
./ssh-key-audit.sh --all-users --json

# New (v1.5.0) - with risk scoring
./ssh-key-audit.sh --all-users --risk --json
```

### Recommended Workflow

1. **Initial audit**: Run with `--risk` to see distribution
2. **Tune weights**: Create `.ssh-audit.conf` if defaults don't match policy
3. **Prioritize**: Focus on CRITICAL/HIGH targets first
4. **Automate**: Add to CI/CD with quality gates
5. **Monitor**: Track risk scores over time in SIEM

## Known Limitations

- Risk scores are target-local (no cross-target aggregation)
- Stale key detection requires `--max-age` flag to calculate ages
- Duplicate detection is per-run (no persistent state)
- Config files use bash syntax (no validation beyond parse errors)

## Future Enhancements (v1.6.0+)

Planned for next release:
- **Drift tracking**: Compare current vs. previous runs
- **Trend analysis**: "Risk increased from MEDIUM to CRITICAL"
- **Snapshot storage**: Persistent risk history
- **Delta mode**: `--delta` flag for change-only reporting

## Files Changed

- `ssh-key-audit.sh`: +400 lines (risk scoring engine + console output)
- `CHANGELOG.md`: v1.5.0 entry
- `examples/ssh-audit.conf`: Sample configuration
- `docs/releases/v1.5.0-release-notes.md`: This file
- `docs/v1.5.0-implementation-guide.md`: Implementation reference

## Credits

Risk scoring system designed and implemented following the v1.5.0 design spec created in collaboration session 2025-11-17.

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
