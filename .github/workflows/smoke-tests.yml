name: Smoke Tests

on:
  push:
    branches: [ main ]
    paths:
      - '**.sh'
      - '.github/workflows/smoke-tests.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '**.sh'
      - '.github/workflows/smoke-tests.yml'

jobs:
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Syntax validation
        run: |
          echo "Validating bash syntax..."
          for script in *.sh; do
            echo "Checking syntax: $script"
            bash -n "$script"
          done

      - name: Help flags test
        run: |
          echo "Testing --help flags..."
          ./disk-cleanup.sh --help
          ./smart-cleanup.sh --help
          ./update-all.sh --help
          ./rclone-sync.sh --help
          ./nmap-scan.sh --help

      - name: Dry run tests
        run: |
          echo "Testing dry-run mode..."
          # disk-cleanup.sh dry run (non-interactive, no gauge, no fun facts)
          ./disk-cleanup.sh --dry-run -y --no-gauge --no-fun

          # update-all.sh dry run
          ./update-all.sh --dry-run

      - name: Scan mode tests
        run: |
          echo "Testing scan/status modes..."
          # Virtualenv scan (won't find much in CI, but tests the code path)
          ./disk-cleanup.sh --scan-venvs -y --no-gauge

          # Smart cleanup status
          ./smart-cleanup.sh --status || true

          # Rclone status (will fail without config, but tests argument parsing)
          ./rclone-sync.sh --status || echo "Expected failure: rclone not configured"

      - name: nmap-scan.sh tests
        run: |
          echo "Testing nmap-scan.sh (graceful dependency handling)..."

          # Test help (should work without nmap)
          ./nmap-scan.sh --help

          # Test dry-run with valid CIDR (should work without nmap)
          ./nmap-scan.sh --cidr "192.168.1.0/24" --dry-run

          # Test CIDR validation (invalid format, should fail gracefully)
          ./nmap-scan.sh --cidr "invalid" --dry-run && exit 1 || echo "✓ CIDR validation works"

          # Test CIDR validation (invalid octet, should fail gracefully)
          ./nmap-scan.sh --cidr "999.168.1.0/24" --dry-run && exit 1 || echo "✓ Octet validation works"

          # Test CIDR validation (invalid prefix, should fail gracefully)
          ./nmap-scan.sh --cidr "192.168.1.0/99" --dry-run && exit 1 || echo "✓ Prefix validation works"

          # Test rate validation (out of range, should fail)
          ./nmap-scan.sh --cidr "192.168.1.0/24" --rate 99999 --dry-run && exit 1 || echo "✓ Rate bounds work"

          # If nmap is available, test that scan fails gracefully when run without privileges
          if command -v nmap >/dev/null 2>&1; then
            echo "✓ nmap available, testing graceful non-root behavior"
            # This will work in dry-run but shows the non-root warnings
            ./nmap-scan.sh --cidr "127.0.0.1/32" --dry-run
          else
            echo "✓ nmap not installed (expected in CI), dependency check should fail gracefully"
            ./nmap-scan.sh --cidr "192.168.1.0/24" && exit 1 || echo "✓ Graceful failure when nmap missing"
          fi

      - name: service-health-check.sh tests
        run: |
          echo "Testing service-health-check.sh (graceful config handling)..."

          # Test help (should always work)
          ./service-health-check.sh --help

          # Test dry-run with example config
          ./service-health-check.sh --dry-run --config examples/services.conf

          # Test --once mode with example config
          ./service-health-check.sh --once --config examples/services.conf || echo "✓ Expected failure without actual services"

          # Test invalid config path (should fail gracefully)
          ./service-health-check.sh --config /nonexistent/config.conf && exit 1 || echo "✓ Config validation works"

          echo "✓ service-health-check.sh validation complete"

      - name: cert-renewal-check.sh tests
        run: |
          echo "Testing cert-renewal-check.sh (SSL certificate monitoring)..."

          # Test help (should always work)
          ./cert-renewal-check.sh --help

          # Create test domains file
          echo -e "github.com\ngoogle.com\n# comment line\ncloudflare.com" > /tmp/test-domains.txt

          # Test dry-run with domains file
          ./cert-renewal-check.sh --domains /tmp/test-domains.txt --dry-run

          # Test warn-days validation (out of range, should fail)
          ./cert-renewal-check.sh --domains /tmp/test-domains.txt --warn-days 999 && exit 1 || echo "✓ Warn-days bounds validation works"

          # Test warn-days validation (negative, should fail)
          ./cert-renewal-check.sh --domains /tmp/test-domains.txt --warn-days 0 && exit 1 || echo "✓ Warn-days minimum validation works"

          # Test missing input (should fail gracefully)
          ./cert-renewal-check.sh && exit 1 || echo "✓ Input validation works"

          # Test JSON output format (dry-run)
          ./cert-renewal-check.sh --domains /tmp/test-domains.txt --json --dry-run

          echo "✓ cert-renewal-check.sh validation complete"

      - name: db-backup.sh tests
        run: |
          echo "Testing db-backup.sh (database backup with retention)..."

          # Test help (should always work)
          ./db-backup.sh --help

          # Test dry-run with PostgreSQL
          export DB_DSN="postgres://testuser:testpass@localhost:5432/testdb"
          ./db-backup.sh --db pg --dry-run

          # Test dry-run with MySQL
          export DB_DSN="mysql://root:password@localhost:3306/appdb"
          ./db-backup.sh --db mysql --dry-run

          # Output path validation (should reject system directories)
          export DB_DSN="mysql://root:password@localhost:3306/appdb"
          ./db-backup.sh --db mysql --out /var/backups/mysql --dry-run && exit 1 || echo "✓ Output path validation works"

          # Test custom retention format
          export DB_DSN="postgres://user:pass@localhost/db"
          ./db-backup.sh --db pg --retention 14:8:24 --dry-run

          # Test invalid database type (should fail)
          ./db-backup.sh --db invalid && exit 1 || echo "✓ DB type validation works"

          # Test invalid retention format (should fail)
          ./db-backup.sh --db pg --retention "7-4-12" && exit 1 || echo "✓ Retention format validation works"

          # Test missing DSN (should fail gracefully)
          unset DB_DSN
          ./db-backup.sh --db pg && exit 1 || echo "✓ DSN validation works"

          # Test password masking in dry-run output
          export DB_DSN="postgres://admin:secretpass@localhost/mydb"
          output=$(./db-backup.sh --db pg --dry-run 2>&1)
          if echo "$output" | grep -q "secretpass"; then
            echo "✗ Password leaked in output!"
            exit 1
          else
            echo "✓ Password masking works"
          fi

          echo "✓ db-backup.sh validation complete"

      - name: compose-redeploy.sh tests
        run: |
          echo "Testing compose-redeploy.sh (graceful config handling)..."

          # Test help (should always work)
          ./compose-redeploy.sh --help

          # Create minimal test compose file
          cat > test-compose.yml << 'COMPOSE'
version: '3.8'
services:
  test:
    image: alpine:latest
    command: sleep 3600
COMPOSE

          # Test dry-run with test compose file
          ./compose-redeploy.sh --file test-compose.yml --dry-run

          # Test invalid compose file (should fail gracefully)
          echo "invalid yaml" > bad-compose.yml
          ./compose-redeploy.sh --file bad-compose.yml --dry-run && exit 1 || echo "✓ Config validation works"

          # Test missing file (should fail gracefully)
          ./compose-redeploy.sh --file nonexistent.yml --dry-run && exit 1 || echo "✓ File existence check works"

          # Test health timeout bounds
          ./compose-redeploy.sh --file test-compose.yml --health-timeout 9999 --dry-run && exit 1 || echo "✓ Timeout bounds work"

          # Test --backup-image flag
          ./compose-redeploy.sh --file test-compose.yml --backup-volumes --backup-image busybox:latest --dry-run
          echo "✓ --backup-image flag works"

          # Cleanup
          rm -f test-compose.yml bad-compose.yml

          echo "✓ compose-redeploy.sh validation complete"

      - name: docker-volume-backup.sh tests
        run: |
          echo "Testing docker-volume-backup.sh (volume backup handling)..."

          # Test help (should always work)
          ./docker-volume-backup.sh --help

          # Test that --volume and --all are mutually exclusive
          ./docker-volume-backup.sh --volume test --all && exit 1 || echo "✓ Mutual exclusivity works"

          # Test that at least one option is required
          ./docker-volume-backup.sh && exit 1 || echo "✓ Argument validation works"

          # Test dry-run with --all (should work even if no volumes exist)
          ./docker-volume-backup.sh --all --dry-run || echo "✓ Dry-run with --all works"

          # If Docker is available, test volume validation
          if command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then
            echo "✓ Docker available, testing volume validation"

            # Test nonexistent volume (should fail gracefully)
            ./docker-volume-backup.sh --volume nonexistent_volume_12345 --dry-run && exit 1 || echo "✓ Volume validation works"

            # Test dry-run with --all
            ./docker-volume-backup.sh --all --dry-run

            # Test --backup-image flag
            ./docker-volume-backup.sh --all --backup-image busybox:latest --dry-run
            echo "✓ --backup-image flag works"
          else
            echo "✓ Docker not available (expected in CI)"
            # Test that script fails gracefully when Docker not available
            ./docker-volume-backup.sh --all && exit 1 || echo "✓ Graceful failure when Docker missing"
          fi

          echo "✓ docker-volume-backup.sh validation complete"

      - name: dyndns-update.sh tests
        run: |
          echo "Testing dyndns-update.sh (dynamic DNS updates)..."

          # Test help (should always work)
          ./dyndns-update.sh --help

          # Test missing required arguments
          ./dyndns-update.sh && exit 1 || echo "✓ Argument validation works"

          # Test unsupported provider
          TEST_TOKEN="test-token-12345" ./dyndns-update.sh --provider invalid --zone example.com --record home --token env:TEST_TOKEN --dry-run && exit 1 || echo "✓ Provider validation works"

          # Test TTL bounds checking
          TEST_TOKEN="test" ./dyndns-update.sh --provider cloudflare --zone example.com --record home --token env:TEST_TOKEN --ttl 30 --dry-run && exit 1 || echo "✓ TTL minimum validation works"
          TEST_TOKEN="test" ./dyndns-update.sh --provider cloudflare --zone example.com --record home --token env:TEST_TOKEN --ttl 99999 --dry-run && exit 1 || echo "✓ TTL maximum validation works"

          # Test environment variable token resolution
          export TEST_CF_TOKEN="test-cloudflare-token"
          ./dyndns-update.sh --provider cloudflare --zone example.com --record home --token env:TEST_CF_TOKEN --dry-run || echo "✓ Token from env works"

          # Test missing environment variable
          ./dyndns-update.sh --provider cloudflare --zone example.com --record home --token env:NONEXISTENT_VAR --dry-run && exit 1 || echo "✓ Missing env var validation works"

          echo "✓ dyndns-update.sh validation complete"

      - name: smart-disk-check.sh tests
        run: |
          echo "Testing smart-disk-check.sh (S.M.A.R.T. monitoring)..."

          # Test help (should always work)
          ./smart-disk-check.sh --help

          # Test dry-run (should work even without smartctl)
          ./smart-disk-check.sh --dry-run

          # Test temperature bounds
          ./smart-disk-check.sh --warn-temp 29 --dry-run && exit 1 || echo "✓ Warn temp lower bound works"
          ./smart-disk-check.sh --warn-temp 81 --dry-run && exit 1 || echo "✓ Warn temp upper bound works"
          ./smart-disk-check.sh --crit-temp 39 --dry-run && exit 1 || echo "✓ Crit temp lower bound works"
          ./smart-disk-check.sh --crit-temp 91 --dry-run && exit 1 || echo "✓ Crit temp upper bound works"

          # Test that crit-temp > warn-temp
          ./smart-disk-check.sh --warn-temp 50 --crit-temp 45 --dry-run && exit 1 || echo "✓ Temp threshold validation works"

          # Test invalid test type
          ./smart-disk-check.sh --test invalid --dry-run && exit 1 || echo "✓ Test type validation works"

          # Check smartctl availability (expected to be missing in CI)
          if ! command -v smartctl >/dev/null 2>&1; then
            echo "✓ smartctl not available (expected in CI)"
            # Test graceful failure when smartctl missing
            ./smart-disk-check.sh && exit 1 || echo "✓ Graceful failure when smartctl missing"
          else
            echo "✓ smartctl available, testing device discovery"
            # If smartctl is present, test with dry-run
            ./smart-disk-check.sh --dry-run
          fi

          echo "✓ smart-disk-check.sh validation complete"

      - name: ssh-key-audit.sh tests
        run: |
          echo "Testing ssh-key-audit.sh (SSH key hygiene)..."

          # Help should work
          ./ssh-key-audit.sh --help

          # Dry-run (no filesystem read)
          ./ssh-key-audit.sh --dry-run

          # Create fixture users under ./tests/fixtures/ssh
          mkdir -p tests/fixtures/ssh/alice/.ssh tests/fixtures/ssh/bob/.ssh
          chmod 700 tests/fixtures/ssh/alice/.ssh tests/fixtures/ssh/bob/.ssh
          echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIExampleKey alice@host' > tests/fixtures/ssh/alice/.ssh/authorized_keys
          echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCExampleKey bob@host' > tests/fixtures/ssh/bob/.ssh/authorized_keys
          chmod 600 tests/fixtures/ssh/alice/.ssh/authorized_keys tests/fixtures/ssh/bob/.ssh/authorized_keys

          # Audit specific users from fixtures with custom home root
          ./ssh-key-audit.sh --users "alice,bob" --home-root tests/fixtures/ssh --json

          # Forbid RSA, fail on weak type should produce exit 2
          ./ssh-key-audit.sh --users "bob" --home-root tests/fixtures/ssh --forbid-types ssh-rsa --fail-on weak-type && exit 1 || echo "✓ fail-on weak-type triggers critical"

          # Mutual exclusion validation
          ./ssh-key-audit.sh --users alice --all-users && exit 1 || echo "✓ users/all-users mutual exclusion works"

          # Max-age bounds
          ./ssh-key-audit.sh --users alice --home-root tests/fixtures/ssh --max-age 99999 && exit 1 || echo "✓ max-age upper bound works"

          echo "✓ ssh-key-audit.sh validation complete"

      - name: new-vm-setup.sh tests
        run: |
          echo "Testing new-vm-setup.sh (VM bootstrapping)..."

          # Test help (should always work)
          ./new-vm-setup.sh --help

          # Test dry-run without sudo (should work)
          ./new-vm-setup.sh \
            --hostname "test-vm" \
            --user "testuser" \
            --ssh-key "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAbc123test test@example.com" \
            --packages "curl,vim" \
            --no-sudo \
            --dry-run

          # Test hostname validation (uppercase - should fail)
          ./new-vm-setup.sh \
            --hostname "Invalid-Host" \
            --user "test" \
            --ssh-key "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAbc123test test@example.com" \
            --dry-run && exit 1 || echo "✓ Hostname uppercase validation works"

          # Test hostname validation (too long - should fail)
          ./new-vm-setup.sh \
            --hostname "this-hostname-is-way-too-long-and-exceeds-sixty-three-characters-limit" \
            --user "test" \
            --ssh-key "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAbc123test test@example.com" \
            --dry-run && exit 1 || echo "✓ Hostname length validation works"

          # Test hostname validation (starts with hyphen - should fail)
          ./new-vm-setup.sh \
            --hostname "-invalid" \
            --user "test" \
            --ssh-key "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAbc123test test@example.com" \
            --dry-run && exit 1 || echo "✓ Hostname format validation works"

          # Test username validation (root - should fail)
          ./new-vm-setup.sh \
            --hostname "test-vm" \
            --user "root" \
            --ssh-key "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAbc123test test@example.com" \
            --dry-run && exit 1 || echo "✓ Username 'root' validation works"

          # Test username validation (starts with number - should fail)
          ./new-vm-setup.sh \
            --hostname "test-vm" \
            --user "1admin" \
            --ssh-key "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAbc123test test@example.com" \
            --dry-run && exit 1 || echo "✓ Username format validation works"

          # Test username validation (uppercase - should fail)
          ./new-vm-setup.sh \
            --hostname "test-vm" \
            --user "Admin" \
            --ssh-key "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAbc123test test@example.com" \
            --dry-run && exit 1 || echo "✓ Username case validation works"

          # Test SSH key validation (invalid prefix - should fail)
          ./new-vm-setup.sh \
            --hostname "test-vm" \
            --user "testuser" \
            --ssh-key "invalid-key-format AAAAC3NzaC1lZDI1NTE5AAAAIAbc123test test@example.com" \
            --dry-run && exit 1 || echo "✓ SSH key validation works"

          # Test missing required args (should fail)
          ./new-vm-setup.sh --dry-run && exit 1 || echo "✓ Required argument validation works"

          # Test dotfiles URL validation (invalid scheme - should fail)
          ./new-vm-setup.sh \
            --hostname "test-vm" \
            --user "testuser" \
            --ssh-key "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAbc123test test@example.com" \
            --dotfiles "ftp://invalid.com/repo.git" \
            --no-sudo \
            --dry-run && exit 1 || echo "✓ Dotfiles URL validation works"

          # Test valid dry-run with all options
          ./new-vm-setup.sh \
            --hostname "full-test" \
            --user "admin" \
            --ssh-key "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAbc123test test@example.com" \
            --packages "curl,vim,git" \
            --dotfiles "https://github.com/test/dotfiles.git" \
            --shell "/bin/bash" \
            --no-sudo \
            --dry-run || echo "✓ Full dry-run works"

          # Test JSON output flag (dry-run, no sudo required)
          ./new-vm-setup.sh \
            --hostname "json-test" \
            --user "jsonuser" \
            --ssh-key "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC test@example.com" \
            --no-sudo \
            --dry-run \
            --json || echo "✓ JSON output flag works"

          echo "✓ new-vm-setup.sh validation complete"

      - name: Smoke tests summary
        if: success()
        run: |
          echo "✅ All smoke tests passed"
          echo "   - Syntax validation: OK"
          echo "   - Help flags: OK"
          echo "   - Dry run modes: OK"
          echo "   - Scan modes: OK"
          echo "   - nmap-scan.sh validation: OK"
          echo "   - service-health-check.sh validation: OK"
          echo "   - cert-renewal-check.sh validation: OK"
          echo "   - db-backup.sh validation: OK"
          echo "   - compose-redeploy.sh validation: OK"
          echo "   - docker-volume-backup.sh validation: OK"
          echo "   - dyndns-update.sh validation: OK"
          echo "   - smart-disk-check.sh validation: OK"
          echo "   - ssh-key-audit.sh validation: OK"
          echo "   - new-vm-setup.sh validation: OK"
